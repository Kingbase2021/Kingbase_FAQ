读写分离
=======================

读写分离分发机制
-------------------------

1、对于只读事务，如果事务内有多条SQL，会将每条SQL发至不同的节点（primary节点按比例，standby节点轮询）

2、对于读写混合事务，在第一个写操作之前，分发机制按读事务处理，包括写之后的所有SQL都在主节点执行

3、读写分离下，如果在备机报错ERROR或者FATAL的SQL，包括备机失败包括进程退出的错误，会把它自动再发送到主机重跑一遍。备机失败转发主机，主机如果也出现错误，并且是非IO错误，就会退出。



如何测试一下现场的备机失败，转发主机的场景？
--------------------------------------------------

问题描述：

   如何测试一下现场的备机失败，转发主机的场景？

解决方案：

   将HOSTLOADRATE设置成0，然后执行一个长查询，比如select sys_sleep(20)，然后杀掉备机。



失败重发机制
--------------------------------------------------

1、参数RETRYTIMES控制失败重试的次数，默认是10。

2、所有的重发都是重发主机

3、备机任意错误失败转发主机，主机失败是IO错误才会失败重发，socket超时是IO错误，但IO错误并不只有socket超时



ssh 引发的相关问题
--------------------------------------------------

1) 集群在启停时，需要ssh 到远程主机，修改crontab , 运行 sys_ctl 等。

2) 在启停集群时，如果主机间的免密认证有问题，会要求输入操作系统用户密码（通常是kingbase用户），只需重配主机间的信任关系。

3) sshd 服务只在集群启停时需要用到，暂时停止ssh服务不影响数据库使用。

 

读写分离备机备份报错
--------------------------------------------------

适用版本：V8R3 , V8R6

问题描述：

   在备机执行Sys_dump时，报错“canceling statement due to conflict with recovery” “User was holding a relation lock for to long”

问题分析：

   备机一直处于recovery模式，在恢复过程中，会中断与恢复冲突的相关操作。比如：同步主机的vacuum 操作，而备机上的Select操作可能需要访问“旧版本”记录，阻止了vacuum操作在备机上的执行。当备机上的查询时间过长是，备机的Recovery操作会终止查询操作（sys_dump本质也是个查询操作）。



读写分离集群Hash索引老是出问题
--------------------------------------------------

适用版本：V8R3

问题描述：

   hash索引在备机不同步。对于异常宕机的情况，也需要重建hash索引。

问题分析：

	由于R3版本hash 索引不记录wal日志，不能用于流复制。

	.. Note::

	   R6 版本已支持hash 索引记录wal日志